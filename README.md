# Self-Aware Adaptive Retrieval

This repository implements **No-RAG**, **RAG-Always**, and (coming soon) **Adaptive RAG** strategies for PubMedQA using a local LLM and FAISS-based retrieval.

---

### 1. Repository Structure

```
self-aware-adaptive-retrieval/
│
├── build_vectorstore.py          # Build embeddings + FAISS vector store
├── retrieve.py                   # Retrieval utilities
├── evaluation.py                 # Main entry for No-RAG & RAG-Always
│
├── scripts/
│   ├── data_check.py             # Dataset sanity checks & statistics
│   ├── context_length_stats.py   # Context token-length analysis
│   ├── plot_rag_always.py        # Plots for accuracy/hallucination/confusion
│
├── results/
│   ├── data_eda/                 # Stats generated by data_check
│   ├── no_rag_local_xxx/         # No-RAG experiment outputs
│   ├── YYYYMMDD_rag-always_xxx/  # RAG-Always experiment outputs
│

```

---

### 2. Environment Setup (UV + GPU Cluster)

**2.1 Create environment**

```bash
uv venv --python 3.12 --seed
source .venv/bin/activate
```

**2.2 Install dependencies**

```bash
uv pip install uv
uv pip install vllm --torch-backend=auto
uv pip install sklearn matplotlib numpy datasets ratelimit openai sentence_transformers
uv pip install faiss-cpu faiss-gpu-cu12
```

---

### 3. Dataset Checking

**3.1 Run data check**

```bash
cd scripts
uv run python data_check.py
```

Outputs saved to:

```
results/data_eda/
```

---

### 4. Building the Vector Store (Embeddings + FAISS)

**4.1 Run vector store builder**

```bash
uv run python build_vectorstore.py
```

> This step may take a long time in interactive cluster mode.

Prebuilt index is available under:

```
/projects/insightx-lab/xinruiwu
```

---

### 5. Running Evaluations

---

### 5.1 Run No-RAG Baseline

```bash
uv run python evaluation.py   --llm local   --model no-rag   --n 1000   --run-name no_rag_local_1000_01   2>&1 | tee logs/no_rag_local_1000_01.log
```

### Output files include:

- baseline_metrics_no-rag.txt
- confusion_matrix_no-rag_local.png
- config.json
- stdout.log

---

### 5.2 Run RAG-Always

```bash
uv run python evaluation.py   --llm local   --model rag-always   --n 1000   2>&1 | tee logs/rag_always_1000_04.log
```

### Output files include:

- rag_sweep_metrics.csv
- rag_confusions.csv
- config.json
- stdout.log

---

### Optinally: 5.3 Test with api endpoint (kept for local test)

```bash
uv run python evaluation.py   --llm api   --model no-rag   --n 1000   2>&1 | tee logs/no_rag_api_1000_04.log
```

API will be quite slow, and not much use now. It may be removed in the final update.

---

### 6. Plotting RAG-Always Results

```bash
cd scripts
uv run python plot_rag_always.py   --csv /path/to/rag_sweep_metrics.csv   --conf-csv /path/to/rag_confusions.csv
```

Generates:

- Accuracy curve
- Hallucination curve
- Best-config confusion matrix

---

### 7. Script Descriptions

**scripts/data_check.py**
- Runs missing-value detection  
- Outputs label distribution  
- Saves plots and text summary  

**scripts/context_length_stats.py**
- Computes context word-length  
- Stats (median ≈ 200, p90 ≈ 258) show chunking is unnecessary  

**scripts/plot_rag_always.py**
- Reads CSV from RAG-Always  
- Plots accuracy/hallucination curves  
- Generates confusion matrix for best configuration  

---

### 8. Output Folder Layout

```
results/
│
├── data_eda/
│   ├── data_overview.txt
│   ├── label_distribution.png
│
├── no_rag_local_1000_01/
│   ├── baseline_metrics_no-rag.txt
│   ├── confusion_matrix_no-rag_local.png
│   ├── config.json
│   └── stdout.log
│
└── YYYYMMDD_local_rag-always_1000/
    ├── rag_sweep_metrics.csv
    ├── rag_confusions.csv
    ├── config.json
    └── stdout.log
```

---

### 9. Notes

- All evaluations support arbitrary --n  
- Vector store needs to be built only once  
- Logging via `tee` is optional but recommended  


